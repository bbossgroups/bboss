package com.frameworkset.filter;

import javax.servlet.ServletRequestEvent;
import javax.servlet.http.HttpServletRequest;

import org.apache.log4j.Logger;

import com.frameworkset.platform.security.AccessControl;
import com.frameworkset.common.poolman.DBUtil;
import com.frameworkset.orm.transaction.TransactionManager;

/**
 * 
 * 
 * <p>Title: BSServletRequestListener.java</p>
 *
 * <p>Description: </p>
 *
 * <p>Copyright: Copyright (c) 2007</p>
 *
 * <p>Company: 湖南科创信息股份有限公司</p>
 * @Date Jul 24, 2008 11:24:52 AM
 * @author biaoping.yin,尹标平
 * @version 1.0
 */
public class BSServletRequestListener implements javax.servlet.ServletRequestListener
{
	private static final Logger log = Logger.getLogger(BSServletRequestListener.class);

	public void requestDestroyed(ServletRequestEvent requestEvent) {
//		System.out.println("requestDestroyed Thread.currentThread():" + Thread.currentThread());
//		System.out.println("requestDestroyed tx before:" + TransactionManager.getTransaction());
		
		if(requestEvent.getServletRequest() instanceof HttpServletRequest )
		{
			HttpServletRequest request = (HttpServletRequest)requestEvent.getServletRequest();
			String uri = request.getRequestURI();

			
			
			if(uri.endsWith(".jsp") || uri.endsWith(".do"))
			{
//				
				boolean state = TransactionManager.destroyTransaction();
				if(state){
					log.debug("A DB transaction leaked in Page ["+ uri +"] has been forcibly destoried. ");
					System.out.println("A DB transaction leaked in Page ["+ uri +"] has been forcibly destoried. ");
				}
//				AccessControl.init(null);

			}
			else if(uri.endsWith(".frame"))
			{
//				AccessControl.init(null);
			}
				
		}		
//		System.out.println("requestDestroyed tx after:" + TransactionManager.getTransaction());
//		
//		System.out.println("requestDestroyed tx after DBUtil.getNumActive():" +DBUtil.getNumActive());
//		System.out.println("requestDestroyed tx after DBUtil.getNumIdle():" +DBUtil.getNumIdle());
	}

	public void requestInitialized(ServletRequestEvent requestEvent) {
//		System.out.println("requestInitialized Thread.currentThread():" + Thread.currentThread());
//		if(requestEvent.getServletRequest() instanceof HttpServletRequest )
//		{
//			HttpServletRequest request = (HttpServletRequest)requestEvent.getServletRequest();
//			String uri = request.getRequestURI();
//			
//			
//			if(uri.endsWith(".jsp") || uri.endsWith(".do"))
//			{
//				System.out.println(uri);
//				TransactionManager.destroyTransaction();
//				AccessControl.init(null);
//			}
//			
//		}
		
	}

}
